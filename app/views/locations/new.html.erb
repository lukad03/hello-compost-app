<script src="//maps.google.com/maps/api/js?v=3.13&sensor=false&libraries=geometry" type="text/javascript"></script>
<script src="//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js" type="text/javascript"></script>

<h1>Add a Location</h1>
<%= simple_form_for @location do |location| %>
  <%= location.input :name, label: 'Name:', maxlength: 50 %>
  <div style='width: 100%;'>
    <div id="map" style='width: 100%; height: 400px;'></div>
  </div>

  <%= location.button :submit, value: "Add Location" %>
<% end %>

<script type="text/javascript">
  var handler = Gmaps.build('Google');
handler.buildMap({ provider: { }, internal: {id: 'map'}}, function(){
  var json_data = [
    {
      id:  1,
      lat: 0,
      lng: 0,
      infowindow: "<div style='color:red;'>Foo</div>" //this html is properly disaplayed
    }
  ];

  //create draggable markers (pass google maps options aas a second arg)
  var markers = handler.addMarkers(json_data, { draggable: true});

  //add markers to original json
  _.each(json_data, function(json, index){
    json.marker = markers[index];
  });

  //add dragend event to markers, triggered when you drop them
  _.each(json_data, function(json){
    google.maps.event.addListener(json.marker.getServiceObject(), "dragend", function(event) {
      var lat = event.latLng.lat();
      var lng = event.latLng.lng();
      console.log('Marker with id: ' + json.id + ' dropped hat lat: ' + lat + ' and lng: ' + lng)
    });
  });
});
</script>
